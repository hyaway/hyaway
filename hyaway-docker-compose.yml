services:
  hyaway:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      # Optional build args (sourced from your environment / .env)
      #
      # - VITE_APP_URL: public URL for OG tags/canonical URLs.
      # - ⚠️ DANGER ZONE: VITE_HYDRUS_ENDPOINT / VITE_HYDRUS_ACCESS_KEY preset credentials
      #   These values are embedded in the JavaScript bundle and exposed to ALL users.
      #   Only use for trusted private instances.
      #   See docs/self-hosting/docker.md for security implications.
      args:
        - VITE_APP_URL
        - VITE_HYDRUS_ENDPOINT
        - VITE_HYDRUS_ACCESS_KEY
    ports:
      - "4929:80" # Access at http://localhost:4929
    restart: unless-stopped

    # ─────────────────────────────────────────────────────────────
    # Security hardening
    # ─────────────────────────────────────────────────────────────

    # Read-only filesystem - container cannot write anywhere
    # Prevents attackers from dropping malware or modifying files
    read_only: true

    # RAM-based writable directories for nginx runtime needs
    # Data is cleared on restart, no persistence for attackers
    tmpfs:
      - /var/cache/nginx # Nginx cache
      - /var/run # PID files

    # Drop all Linux capabilities, add back only what nginx needs
    # Minimizes privilege escalation attack surface
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE # Bind to port 80
      - CHOWN # Change file ownership at startup
      - SETGID # Switch to nginx group
      - SETUID # Switch to nginx user

    # ─────────────────────────────────────────────────────────────
    # Resource limits
    # ─────────────────────────────────────────────────────────────

    # Prevent resource exhaustion attacks and runaway processes
    # Adjust based on your server - these are generous for a static site
    deploy:
      resources:
        limits:
          memory: 128M # Max memory
          cpus: "0.5" # Max half a CPU core
        reservations:
          memory: 32M # Guaranteed memory

    # ─────────────────────────────────────────────────────────────
    # Logging
    # ─────────────────────────────────────────────────────────────

    # Log rotation - prevents disk fill from excessive logs
    # Max 30MB total (3 files × 10MB each)
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # ─────────────────────────────────────────────────────────────
    # Labels
    # ─────────────────────────────────────────────────────────────

    labels:
      # Disable Watchtower auto-updates (if you use it for other containers)
      # You control when to rebuild hyAway
      - "com.centurylinklabs.watchtower.enable=false"
